"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var date_fns_1 = require("date-fns");
var router_1 = require("@angular/router");
var router_2 = require("@angular/router");
var common_1 = require("@angular/common");
var remote = require("../../remote");
var common_2 = require("@angular/common");
// import { MonthNavComponent } from '../../shared/header/month-nav/month-nav.component';
var global_settings_service_service_1 = require("../../shared/services/global-settings-service.service");
;
var HomeComponent = (function () {
    function HomeComponent(hungryService, datePipe, route, location, router, globalSettingsService, adminApi) {
        this.hungryService = hungryService;
        this.datePipe = datePipe;
        this.route = route;
        this.location = location;
        this.router = router;
        this.globalSettingsService = globalSettingsService;
        this.adminApi = adminApi;
        this.date = new Date();
        this.monthDate = new Date();
        this.weekDays = [];
        this.dailymenusMap = new Map();
        this.showLoadSpinner = false;
        this.weeklyTotalPrice = 0;
    }
    HomeComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.currency = this.globalSettingsService.getCurrency();
        this.deadline = this.globalSettingsService.getDeadLine();
        this.notes = this.globalSettingsService.getNotes();
        // this.observable = Observable
        // .zip(this.globalSettingsService.getWorkingDays(), this.controlUserService.getUser(), (wdays: any, controlledUser: any) => {
        //    return { wdays: wdays, controlledUser: controlledUser } })
        // .subscribe((r:observables) => {
        //   this.workingDays = r.wdays;
        //   this.controlledUser = r.controlledUser;
        //   console.log("Controlled user:", r.controlledUser);
        //   this.setup();
        // });
        this.globalSettingsService.getWorkingDays().subscribe(function (wdays) {
            _this.workingDays = wdays;
            //admin
            /*this.observable = this.controlUserService.getUser().subscribe(user => {
              if (user) { console.log("Controlled user:", user); }
              this.controlledUser = user;
              
            });*/
            _this.setup();
        });
    };
    HomeComponent.prototype.setup = function () {
        var _this = this;
        this.sub = this.route.params.subscribe(function (params) {
            var dt = new Date(+params['year'], 1, 1); // (+) converts string 'year' na d 'month' to a number
            dt = date_fns_1.setISOWeek(dt, +params['week']);
            if (date_fns_1.isValid(dt)) {
                dt = date_fns_1.addDays(dt, 1);
                //console.log('router dt:', dt);
                _this.date = dt;
                //this.monthDate = this.date;
                _this.weekDaysCal(date_fns_1.startOfWeek(_this.date, { weekStartsOn: 1 }));
                if (_this.weekDays.length > 0) {
                    _this.monthDate = new Date(_this.weekDays[_this.weekDays.length - 1]);
                }
                else {
                    _this.monthDate = _this.date;
                }
                _this.getCurrentWeeklyMenu(_this.buildweekYear(_this.date));
            }
        });
        if (date_fns_1.isToday(this.date)) {
            this.showLoadSpinner = true;
            this.monthDate = this.date;
            this.weekDaysCal(date_fns_1.startOfWeek(this.date, { weekStartsOn: 1 }));
            this.hungryService.menusWeeklyGet(this.controlledUser ? this.controlledUser.id : null).subscribe(function (dailymenus) {
                _this.showLoadSpinner = false;
                _this.dailymenus = dailymenus;
                _this.weekMenuMap();
            }, function (error) { return _this.showLoadSpinner = false; });
        }
    };
    HomeComponent.prototype.handleUserUpdated = function (menuData, day) {
        var menu = this.dailymenusMap.get(day);
        menu.totalPrice = menuData.price;
        menu.comment = menuData.comment;
        this.dailymenusMap.set(day, menu);
    };
    HomeComponent.prototype.getTotalPrice = function () {
        var weekTotal = 0;
        this.dailymenusMap.forEach(function (menu) {
            if (menu.totalPrice != null) {
                weekTotal += menu.totalPrice;
            }
        });
        return weekTotal;
    };
    HomeComponent.prototype.ngOnDestroy = function () {
        if (this.sub)
            this.sub.unsubscribe();
        if (this.observable)
            this.observable.unsubscribe();
    };
    HomeComponent.prototype.getCurrentWeeklyMenu = function (weekYear) {
        var _this = this;
        this.showLoadSpinner = true;
        this.hungryService.menusWeeklyWeekGet(weekYear, this.controlledUser ? this.controlledUser.id : null).subscribe(function (dailymenus) {
            _this.showLoadSpinner = false;
            _this.dailymenus = dailymenus;
            _this.weekMenuMap();
        }, function (error) { return _this.showLoadSpinner = false; });
    };
    HomeComponent.prototype.weekDaysCal = function (d) {
        this.weekDays = [];
        for (var i = 0; i < 7; i++) {
            var dtStr = this.datePipe.transform(d, 'yyyy-MM-dd');
            if (this.workingDays.indexOf(d.getDay()) > -1) {
                this.weekDays.push(dtStr);
            }
            d = date_fns_1.addDays(d, 1);
        }
        //console.log(this.weekDays);
    };
    HomeComponent.prototype.weekMenuMap = function () {
        this.dailymenusMap.clear();
        for (var i = 0; i < this.dailymenus.length; i++) {
            var dt = new Date(this.dailymenus[i].date);
            var dtStr = this.datePipe.transform(dt, 'yyyy-MM-dd');
            this.dailymenusMap.set(dtStr, this.dailymenus[i]);
        }
    };
    HomeComponent.prototype.getDailyMenusMap = function () {
        return this.dailymenusMap;
    };
    HomeComponent.prototype.getDailyMenu = function (d) {
        for (var _i = 0, _a = this.dailymenus; _i < _a.length; _i++) {
            var dailymenu = _a[_i];
            if (dailymenu.date === d) {
                return dailymenu;
            }
        }
    };
    HomeComponent.prototype.getDailyMenuComment = function (dt) {
        return this.dailymenusMap.get(dt) ? this.dailymenusMap.get(dt).comment : null;
    };
    HomeComponent.prototype.dailyMenuExists = function (dateStr) {
        return this.dailymenusMap.has(dateStr);
    };
    HomeComponent.prototype.previousWeek = function () {
        this.date = date_fns_1.subWeeks(this.date, 1);
        if (date_fns_1.getISOWeek(this.date) === date_fns_1.getISOWeek(new Date()) && this.date.getFullYear() === new Date().getFullYear()) {
            this.router.navigate(['/hungry']);
        }
        else {
            this.navWeekYear(this.date);
        }
    };
    HomeComponent.prototype.currentWeek = function () {
        this.router.navigate(['/hungry']);
    };
    HomeComponent.prototype.nextWeek = function () {
        this.date = date_fns_1.addWeeks(this.date, 1);
        if (date_fns_1.getISOWeek(this.date) === date_fns_1.getISOWeek(new Date()) && this.date.getFullYear() === new Date().getFullYear()) {
            this.router.navigate(['/hungry']);
        }
        else {
            this.navWeekYear(this.date);
        }
    };
    HomeComponent.prototype.navWeekYear = function (dt) {
        this.router.navigate(['/hungry/', date_fns_1.getYear(dt), this.pad(date_fns_1.getISOWeek(dt), 2)]);
    };
    HomeComponent.prototype.buildweekYear = function (dt) {
        return this.pad(date_fns_1.getISOWeek(dt), 2) + '-' + date_fns_1.getISOYear(dt);
    };
    HomeComponent.prototype.pad = function (num, size) {
        var s = num + '';
        while (s.length < size) {
            s = '0' + s;
        }
        return s;
    };
    HomeComponent.prototype.onMonthNavView = function (dt) {
        //this.monthDate = dt;
        if (dt.getMonth() === new Date().getMonth() && dt.getFullYear() === new Date().getFullYear()) {
            this.router.navigate(['/hungry']);
        }
        else {
            this.router.navigate(['/hungry/', date_fns_1.getISOYear(dt), this.pad(date_fns_1.getISOWeek(dt), 2)]);
        }
    };
    HomeComponent.prototype.formattedDay = function (day) {
        var date = new Date(day);
        return (this.datePipe.transform(date, 'EEEE / d MMM'));
    };
    HomeComponent.prototype.formattedDeadline = function (deadline) {
        if (deadline != null) {
            var time = deadline.dTime;
            return ('0' + time.getHours()).slice(-2) + ':' + ('0' + time.getMinutes()).slice(-2);
        }
        else {
            return '';
        }
    };
    HomeComponent.prototype.formattedDeadlineDays = function (deadline) {
        if (deadline != null) {
            switch (deadline.dDays) {
                case 0:
                    return 'the same day';
                case 1:
                    return 'the previous day';
                default:
                    return deadline.dDays + ' days before';
            }
        }
        else {
            return '';
        }
    };
    HomeComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'app-hungry-home',
            templateUrl: './home.component.html',
            styleUrls: ['home.component.css']
        }),
        __metadata("design:paramtypes", [remote.HungryApi, common_2.DatePipe,
            router_2.ActivatedRoute,
            common_1.Location,
            router_1.Router,
            global_settings_service_service_1.GlobalSettingsService, remote.AdminApi])
    ], HomeComponent);
    return HomeComponent;
}());
exports.HomeComponent = HomeComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9tZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJob21lLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUE2RDtBQUM3RCxxQ0FBNkk7QUFDN0ksMENBQXlDO0FBQ3pDLDBDQUF5RDtBQUN6RCwwQ0FBMkM7QUFDM0MscUNBQXVDO0FBQ3ZDLDBDQUEyQztBQUUzQyx5RkFBeUY7QUFDekYseUdBQThGO0FBUXBDLENBQUM7QUFTM0Q7SUFpQkksdUJBQ1UsYUFBK0IsRUFDL0IsUUFBa0IsRUFDbEIsS0FBcUIsRUFDckIsUUFBa0IsRUFDbEIsTUFBYyxFQUNmLHFCQUE0QyxFQUMzQyxRQUF5QjtRQU56QixrQkFBYSxHQUFiLGFBQWEsQ0FBa0I7UUFDL0IsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZiwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBQzNDLGFBQVEsR0FBUixRQUFRLENBQWlCO1FBdEJ6QixTQUFJLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUMzQixjQUFTLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM3QixhQUFRLEdBQWtCLEVBQUUsQ0FBQztRQUUxQixrQkFBYSxHQUFrQyxJQUFJLEdBQUcsRUFBNEIsQ0FBQztRQUl0RixvQkFBZSxHQUFHLEtBQUssQ0FBQztRQUN4QixxQkFBZ0IsR0FBRyxDQUFDLENBQUM7SUFleEIsQ0FBQztJQUVMLGdDQUFRLEdBQVI7UUFBQSxpQkE0QkM7UUEzQkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDekQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDekQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFbkQsK0JBQStCO1FBQy9CLDhIQUE4SDtRQUM5SCxnRUFBZ0U7UUFDaEUsa0NBQWtDO1FBQ2xDLGdDQUFnQztRQUNoQyw0Q0FBNEM7UUFDNUMsdURBQXVEO1FBQ3ZELGtCQUFrQjtRQUNsQixNQUFNO1FBRU4sSUFBSSxDQUFDLHFCQUFxQixDQUFDLGNBQWMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxVQUFBLEtBQUs7WUFDekQsS0FBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7WUFFekIsT0FBTztZQUNQOzs7O2lCQUlLO1lBRUwsS0FBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7SUFFTCxDQUFDO0lBRU0sNkJBQUssR0FBWjtRQUFBLGlCQWlDQztRQS9CQyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFBLE1BQU07WUFDM0MsSUFBSSxFQUFFLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsc0RBQXNEO1lBQ2hHLEVBQUUsR0FBRyxxQkFBVSxDQUFDLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLEVBQUUsQ0FBQyxDQUFDLGtCQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNoQixFQUFFLEdBQUcsa0JBQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBRXBCLGdDQUFnQztnQkFDaEMsS0FBSSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQ2YsNkJBQTZCO2dCQUU3QixLQUFJLENBQUMsV0FBVyxDQUFDLHNCQUFXLENBQUMsS0FBSSxDQUFDLElBQUksRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQzlELEVBQUUsQ0FBQyxDQUFDLEtBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzdCLEtBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSSxDQUFDLFFBQVEsQ0FBQyxLQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyRSxDQUFDO2dCQUNELElBQUksQ0FBQyxDQUFDO29CQUFDLEtBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSSxDQUFDLElBQUksQ0FBQztnQkFBQyxDQUFDO2dCQUVwQyxLQUFJLENBQUMsb0JBQW9CLENBQUMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxLQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUMzRCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsQ0FBQyxrQkFBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7WUFDNUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQzNCLElBQUksQ0FBQyxXQUFXLENBQUMsc0JBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM5RCxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFBLFVBQVU7Z0JBQ3pHLEtBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDO2dCQUM3QixLQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztnQkFDN0IsS0FBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3JCLENBQUMsRUFBRSxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxFQUE1QixDQUE0QixDQUFDLENBQUM7UUFDNUMsQ0FBQztJQUVILENBQUM7SUFHTSx5Q0FBaUIsR0FBeEIsVUFBeUIsUUFBdUIsRUFBRSxHQUFHO1FBQ25ELElBQU0sSUFBSSxHQUFxQixJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFDakMsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQ00scUNBQWEsR0FBcEI7UUFDRSxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDbEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsVUFBQSxJQUFJO1lBQzdCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDNUIsU0FBUyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDL0IsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBQ0QsbUNBQVcsR0FBWDtRQUNFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7WUFBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXJDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7WUFBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JELENBQUM7SUFFTyw0Q0FBb0IsR0FBNUIsVUFBNkIsUUFBZ0I7UUFBN0MsaUJBT0M7UUFOQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztRQUM1QixJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFBLFVBQVU7WUFDdkgsS0FBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7WUFDN0IsS0FBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7WUFDN0IsS0FBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3JCLENBQUMsRUFBRSxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxFQUE1QixDQUE0QixDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVPLG1DQUFXLEdBQW5CLFVBQW9CLENBQU87UUFDekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFFbkIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUUzQixJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFdkQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM1QixDQUFDO1lBRUQsQ0FBQyxHQUFHLGtCQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLENBQUM7UUFFRCw2QkFBNkI7SUFDL0IsQ0FBQztJQUVPLG1DQUFXLEdBQW5CO1FBQ0UsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMzQixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDaEQsSUFBTSxFQUFFLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QyxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDeEQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwRCxDQUFDO0lBQ0gsQ0FBQztJQUVNLHdDQUFnQixHQUF2QjtRQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFTSxvQ0FBWSxHQUFuQixVQUFvQixDQUFNO1FBQ3hCLEdBQUcsQ0FBQyxDQUFrQixVQUFlLEVBQWYsS0FBQSxJQUFJLENBQUMsVUFBVSxFQUFmLGNBQWUsRUFBZixJQUFlO1lBQWhDLElBQUksU0FBUyxTQUFBO1lBQ2hCLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsTUFBTSxDQUFDLFNBQVMsQ0FBQztZQUNuQixDQUFDO1NBQ0Y7SUFDSCxDQUFDO0lBRU0sMkNBQW1CLEdBQTFCLFVBQTJCLEVBQVU7UUFFbkMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDaEYsQ0FBQztJQUVNLHVDQUFlLEdBQXRCLFVBQXVCLE9BQWU7UUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFTSxvQ0FBWSxHQUFuQjtRQUNFLElBQUksQ0FBQyxJQUFJLEdBQUcsbUJBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ25DLEVBQUUsQ0FBQyxDQUFDLHFCQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLHFCQUFVLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDN0csSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlCLENBQUM7SUFDSCxDQUFDO0lBQ00sbUNBQVcsR0FBbEI7UUFDRSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUNNLGdDQUFRLEdBQWY7UUFDRSxJQUFJLENBQUMsSUFBSSxHQUFHLG1CQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNuQyxFQUFFLENBQUMsQ0FBQyxxQkFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxxQkFBVSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzdHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUNwQyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0gsQ0FBQztJQUNPLG1DQUFXLEdBQW5CLFVBQW9CLEVBQVE7UUFDMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxVQUFVLEVBQUUsa0JBQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFVLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFDTyxxQ0FBYSxHQUFyQixVQUFzQixFQUFRO1FBQzVCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFVLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLHFCQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUNPLDJCQUFHLEdBQVgsVUFBWSxHQUFXLEVBQUUsSUFBWTtRQUNuQyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLE9BQU8sQ0FBQyxDQUFDLE1BQU0sR0FBRyxJQUFJLEVBQUUsQ0FBQztZQUN2QixDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUNkLENBQUM7UUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUNNLHNDQUFjLEdBQXJCLFVBQXNCLEVBQVE7UUFDNUIsc0JBQXNCO1FBQ3RCLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxJQUFJLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM3RixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxVQUFVLEVBQUUscUJBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFVLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xGLENBQUM7SUFDSCxDQUFDO0lBRU0sb0NBQVksR0FBbkIsVUFBb0IsR0FBVztRQUM3QixJQUFNLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQixNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU0seUNBQWlCLEdBQXhCLFVBQXlCLFFBQWE7UUFDcEMsRUFBRSxDQUFDLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDckIsSUFBTSxJQUFJLEdBQVMsUUFBUSxDQUFDLEtBQUssQ0FBQztZQUNsQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZGLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDWixDQUFDO0lBQ0gsQ0FBQztJQUVNLDZDQUFxQixHQUE1QixVQUE2QixRQUFhO1FBQ3hDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLE1BQU0sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixLQUFLLENBQUM7b0JBQ0osTUFBTSxDQUFDLGNBQWMsQ0FBQztnQkFDeEIsS0FBSyxDQUFDO29CQUNKLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQztnQkFDNUI7b0JBQ0UsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDO1lBQzNDLENBQUM7UUFDSCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ1osQ0FBQztJQUVILENBQUM7SUFoUFEsYUFBYTtRQVB6QixnQkFBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25CLFFBQVEsRUFBRSxpQkFBaUI7WUFDM0IsV0FBVyxFQUFFLHVCQUF1QjtZQUNwQyxTQUFTLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztTQUNwQyxDQUFDO3lDQW9CMkIsTUFBTSxDQUFDLFNBQVMsRUFDckIsaUJBQVE7WUFDWCx1QkFBYztZQUNYLGlCQUFRO1lBQ1YsZUFBTTtZQUNRLHVEQUFxQixFQUNqQyxNQUFNLENBQUMsUUFBUTtPQXhCMUIsYUFBYSxDQWtQdkI7SUFBRCxvQkFBQztDQUFBLEFBbFBILElBa1BHO0FBbFBVLHNDQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBzdGFydE9mV2Vlaywgc2V0SVNPV2VlaywgZ2V0SVNPV2VlaywgZ2V0SVNPWWVhciwgZ2V0WWVhciwgYWRkV2Vla3MsIGlzVG9kYXksIGFkZERheXMsIGlzVmFsaWQsIHN1YldlZWtzLCBnZXRNb250aCB9IGZyb20gJ2RhdGUtZm5zJztcclxuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0ICogYXMgcmVtb3RlIGZyb20gJy4uLy4uL3JlbW90ZSc7XHJcbmltcG9ydCB7IERhdGVQaXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuIFxyXG4vLyBpbXBvcnQgeyBNb250aE5hdkNvbXBvbmVudCB9IGZyb20gJy4uLy4uL3NoYXJlZC9oZWFkZXIvbW9udGgtbmF2L21vbnRoLW5hdi5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBHbG9iYWxTZXR0aW5nc1NlcnZpY2UgfSBmcm9tICcuLi8uLi9zaGFyZWQvc2VydmljZXMvZ2xvYmFsLXNldHRpbmdzLXNlcnZpY2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzL1J4JztcclxuLy9pbXBvcnQgeyBDb250cm9sVXNlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zaGFyZWQvc2VydmljZXMvY29udHJvbC11c2VyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyB0cmlnZ2VyLCBhbmltYXRlLCBzdHlsZSwgZ3JvdXAsIGFuaW1hdGVDaGlsZCwgcXVlcnksIHN0YWdnZXIsIHRyYW5zaXRpb24sIGtleWZyYW1lcywgc3RhdGUgfSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJztcclxuXHJcbmludGVyZmFjZSBvYnNlcnZhYmxlcyB7XHJcbiAgICB3ZGF5czogYW55LCBjb250cm9sbGVkVXNlcjogYW55XHJcbiAgfVxyXG5pbnRlcmZhY2UgZGFpbHlNZW51RGF0YSB7IHByaWNlOiBudW1iZXIsIGNvbW1lbnQ6IHN0cmluZyB9O1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxyXG4gICAgc2VsZWN0b3I6ICdhcHAtaHVuZ3J5LWhvbWUnLCAgICBcclxuICAgIHRlbXBsYXRlVXJsOiAnLi9ob21lLmNvbXBvbmVudC5odG1sJyxcclxuICAgIHN0eWxlVXJsczogWydob21lLmNvbXBvbmVudC5jc3MnXVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEhvbWVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gICAgcHJvdGVjdGVkIGRhaWx5bWVudXM6IEFycmF5PHJlbW90ZS5EYWlseU1lbnU+O1xyXG4gICAgcHJvdGVjdGVkIGRhdGU6IERhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgcHVibGljIG1vbnRoRGF0ZTogRGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICBwdWJsaWMgd2Vla0RheXM6IEFycmF5PHN0cmluZz4gPSBbXTtcclxuICAgIHByb3RlY3RlZCBzdWI6IGFueTtcclxuICAgIHByb3RlY3RlZCBkYWlseW1lbnVzTWFwOiBNYXA8U3RyaW5nLCByZW1vdGUuRGFpbHlNZW51PiA9IG5ldyBNYXA8U3RyaW5nLCByZW1vdGUuRGFpbHlNZW51PigpO1xyXG4gICAgcHVibGljIGN1cnJlbmN5OiBPYnNlcnZhYmxlPHN0cmluZz47XHJcbiAgICBwdWJsaWMgZGVhZGxpbmU6IE9ic2VydmFibGU8YW55PjtcclxuICAgIHB1YmxpYyBub3RlczogT2JzZXJ2YWJsZTxzdHJpbmc+O1xyXG4gICAgcHVibGljIHNob3dMb2FkU3Bpbm5lciA9IGZhbHNlO1xyXG4gICAgcHVibGljIHdlZWtseVRvdGFsUHJpY2UgPSAwO1xyXG4gICAgcHVibGljIHdvcmtpbmdEYXlzOiBudW1iZXJbXTtcclxuICAgIHByaXZhdGUgb2JzZXJ2YWJsZTogYW55XHJcbiAgICAvL2FkbWluXHJcbiAgICBwdWJsaWMgY29udHJvbGxlZFVzZXI6IHJlbW90ZS5Vc2VyO1xyXG4gIFxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgIHByaXZhdGUgaHVuZ3J5U2VydmljZTogcmVtb3RlLkh1bmdyeUFwaSxcclxuICAgICAgcHJpdmF0ZSBkYXRlUGlwZTogRGF0ZVBpcGUsXHJcbiAgICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxyXG4gICAgICBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbixcclxuICAgICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcclxuICAgICAgcHVibGljIGdsb2JhbFNldHRpbmdzU2VydmljZTogR2xvYmFsU2V0dGluZ3NTZXJ2aWNlLFxyXG4gICAgICBwcml2YXRlIGFkbWluQXBpOiByZW1vdGUuQWRtaW5BcGksXHJcbiAgICAgIC8vcHJpdmF0ZSBjb250cm9sVXNlclNlcnZpY2U6IENvbnRyb2xVc2VyU2VydmljZVxyXG4gICAgKSB7IH1cclxuICBcclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICB0aGlzLmN1cnJlbmN5ID0gdGhpcy5nbG9iYWxTZXR0aW5nc1NlcnZpY2UuZ2V0Q3VycmVuY3koKTtcclxuICAgICAgdGhpcy5kZWFkbGluZSA9IHRoaXMuZ2xvYmFsU2V0dGluZ3NTZXJ2aWNlLmdldERlYWRMaW5lKCk7XHJcbiAgICAgIHRoaXMubm90ZXMgPSB0aGlzLmdsb2JhbFNldHRpbmdzU2VydmljZS5nZXROb3RlcygpO1xyXG4gIFxyXG4gICAgICAvLyB0aGlzLm9ic2VydmFibGUgPSBPYnNlcnZhYmxlXHJcbiAgICAgIC8vIC56aXAodGhpcy5nbG9iYWxTZXR0aW5nc1NlcnZpY2UuZ2V0V29ya2luZ0RheXMoKSwgdGhpcy5jb250cm9sVXNlclNlcnZpY2UuZ2V0VXNlcigpLCAod2RheXM6IGFueSwgY29udHJvbGxlZFVzZXI6IGFueSkgPT4ge1xyXG4gICAgICAvLyAgICByZXR1cm4geyB3ZGF5czogd2RheXMsIGNvbnRyb2xsZWRVc2VyOiBjb250cm9sbGVkVXNlciB9IH0pXHJcbiAgICAgIC8vIC5zdWJzY3JpYmUoKHI6b2JzZXJ2YWJsZXMpID0+IHtcclxuICAgICAgLy8gICB0aGlzLndvcmtpbmdEYXlzID0gci53ZGF5cztcclxuICAgICAgLy8gICB0aGlzLmNvbnRyb2xsZWRVc2VyID0gci5jb250cm9sbGVkVXNlcjtcclxuICAgICAgLy8gICBjb25zb2xlLmxvZyhcIkNvbnRyb2xsZWQgdXNlcjpcIiwgci5jb250cm9sbGVkVXNlcik7XHJcbiAgICAgIC8vICAgdGhpcy5zZXR1cCgpO1xyXG4gICAgICAvLyB9KTtcclxuICBcclxuICAgICAgdGhpcy5nbG9iYWxTZXR0aW5nc1NlcnZpY2UuZ2V0V29ya2luZ0RheXMoKS5zdWJzY3JpYmUod2RheXMgPT4ge1xyXG4gICAgICAgIHRoaXMud29ya2luZ0RheXMgPSB3ZGF5cztcclxuICBcclxuICAgICAgICAvL2FkbWluXHJcbiAgICAgICAgLyp0aGlzLm9ic2VydmFibGUgPSB0aGlzLmNvbnRyb2xVc2VyU2VydmljZS5nZXRVc2VyKCkuc3Vic2NyaWJlKHVzZXIgPT4ge1xyXG4gICAgICAgICAgaWYgKHVzZXIpIHsgY29uc29sZS5sb2coXCJDb250cm9sbGVkIHVzZXI6XCIsIHVzZXIpOyB9XHJcbiAgICAgICAgICB0aGlzLmNvbnRyb2xsZWRVc2VyID0gdXNlcjtcclxuICAgICAgICAgIFxyXG4gICAgICAgIH0pOyovXHJcbiAgXHJcbiAgICAgICAgdGhpcy5zZXR1cCgpO1xyXG4gICAgICB9KTtcclxuICBcclxuICAgIH1cclxuICBcclxuICAgIHB1YmxpYyBzZXR1cCgpIHtcclxuICBcclxuICAgICAgdGhpcy5zdWIgPSB0aGlzLnJvdXRlLnBhcmFtcy5zdWJzY3JpYmUocGFyYW1zID0+IHtcclxuICAgICAgICBsZXQgZHQgPSBuZXcgRGF0ZSgrcGFyYW1zWyd5ZWFyJ10sIDEsIDEpOyAvLyAoKykgY29udmVydHMgc3RyaW5nICd5ZWFyJyBuYSBkICdtb250aCcgdG8gYSBudW1iZXJcclxuICAgICAgICBkdCA9IHNldElTT1dlZWsoZHQsICtwYXJhbXNbJ3dlZWsnXSk7XHJcbiAgICAgICAgaWYgKGlzVmFsaWQoZHQpKSB7XHJcbiAgICAgICAgICBkdCA9IGFkZERheXMoZHQsIDEpO1xyXG4gIFxyXG4gICAgICAgICAgLy9jb25zb2xlLmxvZygncm91dGVyIGR0OicsIGR0KTtcclxuICAgICAgICAgIHRoaXMuZGF0ZSA9IGR0O1xyXG4gICAgICAgICAgLy90aGlzLm1vbnRoRGF0ZSA9IHRoaXMuZGF0ZTtcclxuICBcclxuICAgICAgICAgIHRoaXMud2Vla0RheXNDYWwoc3RhcnRPZldlZWsodGhpcy5kYXRlLCB7IHdlZWtTdGFydHNPbjogMSB9KSk7XHJcbiAgICAgICAgICBpZiAodGhpcy53ZWVrRGF5cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMubW9udGhEYXRlID0gbmV3IERhdGUodGhpcy53ZWVrRGF5c1t0aGlzLndlZWtEYXlzLmxlbmd0aCAtIDFdKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGVsc2UgeyB0aGlzLm1vbnRoRGF0ZSA9IHRoaXMuZGF0ZTsgfVxyXG4gIFxyXG4gICAgICAgICAgdGhpcy5nZXRDdXJyZW50V2Vla2x5TWVudSh0aGlzLmJ1aWxkd2Vla1llYXIodGhpcy5kYXRlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICBcclxuICAgICAgaWYgKGlzVG9kYXkodGhpcy5kYXRlKSkge1xyXG4gICAgICAgIHRoaXMuc2hvd0xvYWRTcGlubmVyID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLm1vbnRoRGF0ZSA9IHRoaXMuZGF0ZTtcclxuICAgICAgICB0aGlzLndlZWtEYXlzQ2FsKHN0YXJ0T2ZXZWVrKHRoaXMuZGF0ZSwgeyB3ZWVrU3RhcnRzT246IDEgfSkpO1xyXG4gICAgICAgIHRoaXMuaHVuZ3J5U2VydmljZS5tZW51c1dlZWtseUdldCh0aGlzLmNvbnRyb2xsZWRVc2VyID8gdGhpcy5jb250cm9sbGVkVXNlci5pZCA6IG51bGwpLnN1YnNjcmliZShkYWlseW1lbnVzID0+IHtcclxuICAgICAgICAgIHRoaXMuc2hvd0xvYWRTcGlubmVyID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmRhaWx5bWVudXMgPSBkYWlseW1lbnVzO1xyXG4gICAgICAgICAgdGhpcy53ZWVrTWVudU1hcCgpO1xyXG4gICAgICAgIH0sIGVycm9yID0+IHRoaXMuc2hvd0xvYWRTcGlubmVyID0gZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgXHJcbiAgICB9XHJcbiAgXHJcbiAgXHJcbiAgICBwdWJsaWMgaGFuZGxlVXNlclVwZGF0ZWQobWVudURhdGE6IGRhaWx5TWVudURhdGEsIGRheSkge1xyXG4gICAgICBjb25zdCBtZW51OiByZW1vdGUuRGFpbHlNZW51ID0gdGhpcy5kYWlseW1lbnVzTWFwLmdldChkYXkpO1xyXG4gICAgICBtZW51LnRvdGFsUHJpY2UgPSBtZW51RGF0YS5wcmljZTtcclxuICAgICAgbWVudS5jb21tZW50ID0gbWVudURhdGEuY29tbWVudDtcclxuICAgICAgdGhpcy5kYWlseW1lbnVzTWFwLnNldChkYXksIG1lbnUpO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGdldFRvdGFsUHJpY2UoKSB7XHJcbiAgICAgIGxldCB3ZWVrVG90YWwgPSAwO1xyXG4gICAgICB0aGlzLmRhaWx5bWVudXNNYXAuZm9yRWFjaChtZW51ID0+IHtcclxuICAgICAgICBpZiAobWVudS50b3RhbFByaWNlICE9IG51bGwpIHtcclxuICAgICAgICAgIHdlZWtUb3RhbCArPSBtZW51LnRvdGFsUHJpY2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIHdlZWtUb3RhbDtcclxuICAgIH1cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICBpZiAodGhpcy5zdWIpIHRoaXMuc3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgXHJcbiAgICAgIGlmICh0aGlzLm9ic2VydmFibGUpIHRoaXMub2JzZXJ2YWJsZS51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgcHJpdmF0ZSBnZXRDdXJyZW50V2Vla2x5TWVudSh3ZWVrWWVhcjogc3RyaW5nKSB7XHJcbiAgICAgIHRoaXMuc2hvd0xvYWRTcGlubmVyID0gdHJ1ZTtcclxuICAgICAgdGhpcy5odW5ncnlTZXJ2aWNlLm1lbnVzV2Vla2x5V2Vla0dldCh3ZWVrWWVhciwgdGhpcy5jb250cm9sbGVkVXNlciA/IHRoaXMuY29udHJvbGxlZFVzZXIuaWQgOiBudWxsKS5zdWJzY3JpYmUoZGFpbHltZW51cyA9PiB7XHJcbiAgICAgICAgdGhpcy5zaG93TG9hZFNwaW5uZXIgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmRhaWx5bWVudXMgPSBkYWlseW1lbnVzO1xyXG4gICAgICAgIHRoaXMud2Vla01lbnVNYXAoKTtcclxuICAgICAgfSwgZXJyb3IgPT4gdGhpcy5zaG93TG9hZFNwaW5uZXIgPSBmYWxzZSk7XHJcbiAgICB9XHJcbiAgXHJcbiAgICBwcml2YXRlIHdlZWtEYXlzQ2FsKGQ6IERhdGUpIHtcclxuICAgICAgdGhpcy53ZWVrRGF5cyA9IFtdO1xyXG4gIFxyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDc7IGkrKykge1xyXG4gIFxyXG4gICAgICAgIGNvbnN0IGR0U3RyID0gdGhpcy5kYXRlUGlwZS50cmFuc2Zvcm0oZCwgJ3l5eXktTU0tZGQnKTtcclxuICBcclxuICAgICAgICBpZiAodGhpcy53b3JraW5nRGF5cy5pbmRleE9mKGQuZ2V0RGF5KCkpID4gLTEpIHtcclxuICAgICAgICAgIHRoaXMud2Vla0RheXMucHVzaChkdFN0cik7XHJcbiAgICAgICAgfVxyXG4gIFxyXG4gICAgICAgIGQgPSBhZGREYXlzKGQsIDEpO1xyXG4gICAgICB9XHJcbiAgXHJcbiAgICAgIC8vY29uc29sZS5sb2codGhpcy53ZWVrRGF5cyk7XHJcbiAgICB9XHJcbiAgXHJcbiAgICBwcml2YXRlIHdlZWtNZW51TWFwKCkge1xyXG4gICAgICB0aGlzLmRhaWx5bWVudXNNYXAuY2xlYXIoKTtcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhaWx5bWVudXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjb25zdCBkdCA9IG5ldyBEYXRlKHRoaXMuZGFpbHltZW51c1tpXS5kYXRlKTtcclxuICAgICAgICBjb25zdCBkdFN0ciA9IHRoaXMuZGF0ZVBpcGUudHJhbnNmb3JtKGR0LCAneXl5eS1NTS1kZCcpO1xyXG4gICAgICAgIHRoaXMuZGFpbHltZW51c01hcC5zZXQoZHRTdHIsIHRoaXMuZGFpbHltZW51c1tpXSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICBcclxuICAgIHB1YmxpYyBnZXREYWlseU1lbnVzTWFwKCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5kYWlseW1lbnVzTWFwO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgcHVibGljIGdldERhaWx5TWVudShkOiBhbnkpIHtcclxuICAgICAgZm9yIChsZXQgZGFpbHltZW51IG9mIHRoaXMuZGFpbHltZW51cykge1xyXG4gICAgICAgIGlmIChkYWlseW1lbnUuZGF0ZSA9PT0gZCkge1xyXG4gICAgICAgICAgcmV0dXJuIGRhaWx5bWVudTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICBcclxuICAgIHB1YmxpYyBnZXREYWlseU1lbnVDb21tZW50KGR0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gIFxyXG4gICAgICByZXR1cm4gdGhpcy5kYWlseW1lbnVzTWFwLmdldChkdCkgPyB0aGlzLmRhaWx5bWVudXNNYXAuZ2V0KGR0KS5jb21tZW50IDogbnVsbDtcclxuICAgIH1cclxuICBcclxuICAgIHB1YmxpYyBkYWlseU1lbnVFeGlzdHMoZGF0ZVN0cjogU3RyaW5nKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmRhaWx5bWVudXNNYXAuaGFzKGRhdGVTdHIpO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgcHVibGljIHByZXZpb3VzV2VlaygpIHtcclxuICAgICAgdGhpcy5kYXRlID0gc3ViV2Vla3ModGhpcy5kYXRlLCAxKTtcclxuICAgICAgaWYgKGdldElTT1dlZWsodGhpcy5kYXRlKSA9PT0gZ2V0SVNPV2VlayhuZXcgRGF0ZSgpKSAmJiB0aGlzLmRhdGUuZ2V0RnVsbFllYXIoKSA9PT0gbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpKSB7XHJcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycvaHVuZ3J5J10pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMubmF2V2Vla1llYXIodGhpcy5kYXRlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHVibGljIGN1cnJlbnRXZWVrKCkge1xyXG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJy9odW5ncnknXSk7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgbmV4dFdlZWsoKSB7XHJcbiAgICAgIHRoaXMuZGF0ZSA9IGFkZFdlZWtzKHRoaXMuZGF0ZSwgMSk7XHJcbiAgICAgIGlmIChnZXRJU09XZWVrKHRoaXMuZGF0ZSkgPT09IGdldElTT1dlZWsobmV3IERhdGUoKSkgJiYgdGhpcy5kYXRlLmdldEZ1bGxZZWFyKCkgPT09IG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSkge1xyXG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnL2h1bmdyeSddKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLm5hdldlZWtZZWFyKHRoaXMuZGF0ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHByaXZhdGUgbmF2V2Vla1llYXIoZHQ6IERhdGUpIHtcclxuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycvaHVuZ3J5LycsIGdldFllYXIoZHQpLCB0aGlzLnBhZChnZXRJU09XZWVrKGR0KSwgMildKTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgYnVpbGR3ZWVrWWVhcihkdDogRGF0ZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5wYWQoZ2V0SVNPV2VlayhkdCksIDIpICsgJy0nICsgZ2V0SVNPWWVhcihkdCk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIHBhZChudW06IG51bWJlciwgc2l6ZTogbnVtYmVyKTogc3RyaW5nIHtcclxuICAgICAgbGV0IHMgPSBudW0gKyAnJztcclxuICAgICAgd2hpbGUgKHMubGVuZ3RoIDwgc2l6ZSkge1xyXG4gICAgICAgIHMgPSAnMCcgKyBzO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBzO1xyXG4gICAgfVxyXG4gICAgcHVibGljIG9uTW9udGhOYXZWaWV3KGR0OiBEYXRlKSB7XHJcbiAgICAgIC8vdGhpcy5tb250aERhdGUgPSBkdDtcclxuICAgICAgaWYgKGR0LmdldE1vbnRoKCkgPT09IG5ldyBEYXRlKCkuZ2V0TW9udGgoKSAmJiBkdC5nZXRGdWxsWWVhcigpID09PSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCkpIHtcclxuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJy9odW5ncnknXSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycvaHVuZ3J5LycsIGdldElTT1llYXIoZHQpLCB0aGlzLnBhZChnZXRJU09XZWVrKGR0KSwgMildKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIFxyXG4gICAgcHVibGljIGZvcm1hdHRlZERheShkYXk6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShkYXkpO1xyXG4gICAgICByZXR1cm4gKHRoaXMuZGF0ZVBpcGUudHJhbnNmb3JtKGRhdGUsICdFRUVFIC8gZCBNTU0nKSk7XHJcbiAgICB9XHJcbiAgXHJcbiAgICBwdWJsaWMgZm9ybWF0dGVkRGVhZGxpbmUoZGVhZGxpbmU6IGFueSk6IHN0cmluZyB7XHJcbiAgICAgIGlmIChkZWFkbGluZSAhPSBudWxsKSB7XHJcbiAgICAgICAgY29uc3QgdGltZTogRGF0ZSA9IGRlYWRsaW5lLmRUaW1lO1xyXG4gICAgICAgIHJldHVybiAoJzAnICsgdGltZS5nZXRIb3VycygpKS5zbGljZSgtMikgKyAnOicgKyAoJzAnICsgdGltZS5nZXRNaW51dGVzKCkpLnNsaWNlKC0yKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICBcclxuICAgIHB1YmxpYyBmb3JtYXR0ZWREZWFkbGluZURheXMoZGVhZGxpbmU6IGFueSk6IHN0cmluZyB7XHJcbiAgICAgIGlmIChkZWFkbGluZSAhPSBudWxsKSB7XHJcbiAgICAgICAgc3dpdGNoIChkZWFkbGluZS5kRGF5cykge1xyXG4gICAgICAgICAgY2FzZSAwOlxyXG4gICAgICAgICAgICByZXR1cm4gJ3RoZSBzYW1lIGRheSc7XHJcbiAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgIHJldHVybiAndGhlIHByZXZpb3VzIGRheSc7XHJcbiAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICByZXR1cm4gZGVhZGxpbmUuZERheXMgKyAnIGRheXMgYmVmb3JlJztcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICB9XHJcbiAgXHJcbiAgICB9XHJcbiAgXHJcbiAgfVxyXG4gICJdfQ==